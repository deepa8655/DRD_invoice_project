{% extends "base.html" %}
{% block content %}
<h3>Create New Invoice</h3>
<form method="post" enctype="multipart/form-data">
  <div class="row">
    <div class="col-md-4 mb-2">
      <label>Invoice No</label>
    <input class="form-control" name="invoice_no" value="{{ next_invoice_no }}" required readonly>
    </div>
    <div class="col-md-4 mb-2">
      <label>From Date</label>     
      <input class="form-control" type="date" name="from_date">
    </div>
    <div class="col-md-4 mb-2">
      <label>To Date</label>      
      <input class="form-control" type="date" name="to_date">
    </div>
  </div>

  <div class="row mt-2">
    <div class="col-md-4">
      <label>Invoice Date</label>   
      <input class="form-control" type="date" name="invoice_date" value="{{ today }}">
    </div>

    <div class="col-md-8">
      <label>Customer Name</label>
      <select class="form-control" name="customer_name" id="customer_select" required>
        <option value="">-- Select Customer --</option>
        {% for cust in customers %}
          <option value="{{ cust.name }}" data-id="{{ cust.id }}">{{ cust.name }}</option>
        {% endfor %}
      </select>
        <a href="{{ url_for('manage_customers') }}" class="btn btn-outline-primary">Manage Customers</a>

    </div>
  </div>

  <div class="row mt-2">
    <div class="col-md-4">
      <label>Customer GST No</label>
      <input class="form-control" id="customer_gst" name="customer_gst" readonly>
    </div>
    <div class="col-md-4">
      <label>Customer PAN No</label>
      <input class="form-control" id="customer_pan" name="customer_pan" readonly>
    </div>
    <div class="col-md-4">
      <label>State</label>
      <input class="form-control" id="state" name="state" readonly>
    </div>
  </div>

  <hr>
  <h5>ðŸ“¦ Items</h5>
  <table class="table table-sm table-bordered" id="items_table">
    <thead>
      <tr>
        <th>Sr No</th>
        <th>Date</th>
        <th>AWB No.</th>
        <th>Destination</th>
        <th>Weight</th>
        <th>Amount</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><input class="form-control" name="sr_no[]" value="1"></td>  
        <td><input class="form-control" name="item_date[]"></td>
        <td><input class="form-control" name="awb_no[]"></td>
        <td><input class="form-control" name="destination[]"></td>
        <td><input class="form-control" name="weight[]"></td>
        <td><input class="form-control" name="item_amount[]" value="0.00"></td>
      </tr>
    </tbody>
  </table>
  <button type="button" class="btn btn-sm btn-outline-primary" onclick="addRow()">âž• Add Row</button>

  <hr>
  <h4>ðŸ“¤ Upload Items via Excel</h4>
  <div class="mb-3">
    <input type="file" id="excel_file" accept=".xlsx,.xls">
    <button type="button" class="btn btn-outline-primary" onclick="uploadExcel()">Upload Excel</button>
    <a href="{{ url_for('download_template') }}" class="btn btn-outline-success">ðŸ“¥ Download Template</a>
  </div>

  <hr>
  <div class="row">
    <div class="col-md-3">
      <label>Fuel %</label>
      <input name="fuel_percentage" class="form-control" value="0">
    </div>
    <div class="col-md-3">
      <label>GST Type</label>
      <select name="gst_type" class="form-control">
        <option value="CGST_SGST">CGST + SGST</option>
        <option value="IGST">IGST</option>
        <option value="NA">NA</option>
      </select>
    </div>
    <div class="col-md-3">
      <label>GST Rate(%)</label>
      <input name="gst_rate" class="form-control" value="0">
    </div>
<div class="col-md-3">
      <label>Additional Charges</label>
      <input name="additional_charges" class="form-control" value="0">
    </div>
  </div>

  <div class="mt-3">
    <label>Remarks</label>
    <textarea class="form-control" name="remarks"></textarea>
  </div>

  <div class="mt-3">
    <button class="btn btn-success">ðŸ’¾ Save Invoice</button>
    <a href="{{ url_for('index') }}" class="btn btn-secondary">Cancel</a>
  </div>
</form>


<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
document.getElementById('customer_select').addEventListener('change', function() {
  const selected = this.options[this.selectedIndex];
  const customerId = selected.getAttribute('data-id');
  if (!customerId) return;

  fetch(`/customer/${customerId}`)
    .then(res => res.json())
    .then(data => {
      if (data.error) return alert(data.error);
      document.getElementById('customer_gst').value = data.gst_no || '';
      document.getElementById('customer_pan').value = data.pan_no || '';
      document.getElementById('state').value = data.state || '';
    })
    .catch(err => console.error(err));
});

function addRow(){
  const tbody = document.querySelector('#items_table tbody');
  const rowCount = tbody.querySelectorAll('tr').length;
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input class="form-control" name="sr_no[]" value="${rowCount+1}"></td>
    <td><input class="form-control" name="item_date[]"></td>
    <td><input class="form-control" name="awb_no[]"></td>
    <td><input class="form-control" name="destination[]"></td>
    <td><input class="form-control" name="weight[]"></td>
    <td><input class="form-control" name="item_amount[]" value="0.00"></td>
  `;
  tbody.appendChild(tr);
}

function uploadExcel() {
  const fileInput = document.getElementById('excel_file');
  const file = fileInput.files[0];

  if (!file) {
    alert('âš ï¸ Please select an Excel file!');
    return;
  }

  const reader = new FileReader();
  reader.onload = function(e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];

    // ðŸ§© Convert without auto date formatting
    const rows = XLSX.utils.sheet_to_json(sheet, { raw: false, dateNF: "yyyy-mm-dd" });

    if (!rows.length) {
      alert("âŒ Excel file is empty!");
      return;
    }

    // âœ… Expected columns
    const expected = ['Date', 'AWB No', 'Destination', 'Weight', 'Amount'];
    const missing = expected.filter(col => !Object.keys(rows[0]).includes(col));
    if (missing.length > 0) {
      alert("âš ï¸ Missing columns in Excel: " + missing.join(', '));
      return;
    }

    const tbody = document.querySelector('#items_table tbody');
    tbody.innerHTML = '';

    rows.forEach((r, i) => {
      // Keep date exactly as it appears in Excel
      let dateValue = r['Date'];
      if (typeof dateValue === 'number') {
        // If Excel auto-converted to number, change it back to plain text
        const excelDate = XLSX.SSF.format("yyyy-mm-dd", dateValue);
        dateValue = excelDate;
      }

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input class="form-control" name="sr_no[]" value="${i + 1}" readonly></td>
        <td><input class="form-control" name="item_date[]" value="${dateValue || ''}"></td>
        <td><input class="form-control" name="awb_no[]" value="${r['AWB No'] || ''}"></td>
        <td><input class="form-control" name="destination[]" value="${r['Destination'] || ''}"></td>
        <td><input class="form-control" name="weight[]" value="${r['Weight'] || ''}"></td>
        <td><input class="form-control" name="item_amount[]" value="${r['Amount'] || '0.00'}"></td>
      `;
      tbody.appendChild(tr);
    });

    alert("âœ… Excel data uploaded successfully!");
  };

  reader.readAsArrayBuffer(file);
}
</script>

{% endblock %}
